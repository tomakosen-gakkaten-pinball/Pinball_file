# picのファイルについて
## pic16F1826/27の仕様について
　pic1827_photointerruptor.cにて、主に使われているレジスタと機能を示す。なお、TRISA・TRISB等を総称して、TRISXのように簡略化して示す。

- OSCCON : 内部クロックの設定
- TRISX  : ポートXの入出力を設定(0:出力　1:入力)
- ANSELA : ポートXのアナログ選択
- PORTX  : ポートXの初期化及び代入
- PIRXbits.TMR2IF : Timer2 がオーバーフローしたときに 1 になる割り込みフラグ
- TMRX   : TimerXモジュールのレジスタ
- TXCON  : TimerXがオーバーフローする周期の設定
- PRX    : TimerXの周期を設定
- PIE    : TimerXの割り込みを許可
- INTCON : 割り込み全体の制御
- SSPxMSK: I2Cスレーブとして使う際の、アドレスマスクの設定
- SSPxSTAT: I2Cの通信状況の確認(ビットの構成については、pdfの279ページを参照)
- SSPxCON1 : スレーブとマスターの設定
- SSPxADD : スレーブの場合、スレーブアドレスの設定
- SSPxIF  : I2Cの割り込みフラグ
- .xxx   : レジスタXのxxxが示すビットを参照

　その他レジスタと機能については、「PIC16F1827.pdf」を参照してください。

## picのプログラムについて
  pic1827_photointerruptor.cの主なプログラムの処理を示す。  

### 57~78行目
　関数init()では、以下の設定を行った。

- 内部クロック : 4MHz
- ポートA : RA1を入力、そのほかを出力
- ポートB : RB1～RB6を入力、RB0とRB7を出力
- Timer2 : プリスケーラ1/4、PR2=10で約50µs周期
- 割り込み : Timer2割り込みの有効か、グローバル割り込みの許可

### 82~96行目
　関数　i2c_slave_init()ではpic1827をi2cスレーブとして使用するために、初期化をした。  

- アドレス設定 : 7ビットスレーブアドレス
- マスク設定 : アドレス比較は上位7ビットのみ
- 動作モード・ピン設定 : RB1とRB4を入力、i2c機能の有効化、スレーブ7ビットアドレスモード
- 通信仕様 : スルーレート制御を無効か
- 割り込み設定 : MSSP1割り込みを有効化、グローバル周辺割り込みを許可、MSSP1割り込みフラグ初期化


### 106~137行目
　割り込みの際に実行視される処理を定義する。  

- 107~111行 :　この割り込みの処理はTimer2がオーバーフローした場合に、RA2ピンをトグル、割り込みフラグを  
　　　　　  　クリアにする。このフラグをクリアにする処理をしない場合は、再度割り込みが発生しない。  
- 113行     :　i2c通信が起こると受信バッファを読み出すことで、受信完了処理を確定させる。  
- 120~124行 :　マスターが読み取り要求をした場合、アドレス受信後はSSP1BUFのデータをbufに書き込み、バッファが空になった場合は、マスターに最初に返す値を0にする。
- 125~132行 :　マスターがACKを返した場合、スレーブは送信レジスタが空になるのを待ち、scoreの下位4ビットを送信する。送信した分をscoreから削除し、CKP=1にしてクロックを開放する。
- 134~135行 :　割り込みフラグをクリアにして、CKP=1でクロックストレッチを解除し、通信を続行可能にする。

### 148~189行目
　mainの処理を定義する。なお、変数scoreは8ビットのフラグカウンタとして使用する。

- RB2が動作すると5ビット目をフラグとして確認する。まだ、フラグがったっていない場合は、フラグと最下位bitを1にする。RB2が動作が終了すると、フラグをクリアして、再度カウントをできるようにする。
- RB3、RB5、RB6も同様に、6ビット目、7ビット目、8ビット目をフラグとして確認する。